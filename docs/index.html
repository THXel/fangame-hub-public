\
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>THXel Fangame Hub Public</title>
  <link rel="stylesheet" href="assets/style.css" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" referrerpolicy="no-referrer">
</head>
<body>
  <div class="tabBar">
    <button class="tabBtn" data-tab="lib"><i class="fa-solid fa-book"></i> Library</button>
    <button class="tabBtn" data-tab="stats"><i class="fa-solid fa-chart-simple"></i> Stats</button>
    <button class="tabBtn" data-tab="boshy"><i class="fa-solid fa-stopwatch"></i> Boshy Speedrun</button>
  </div>

  <div id="view"></div>

<script>
const $ = (sel, el=document)=>el.querySelector(sel);
const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));

function setActiveTab(tab){
  $$(".tabBtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
}

function setHash(tab){ location.hash = tab; }

function renderPlaceholder(title){
  $("#view").innerHTML = `<div class="card"><div class="h1">${title}</div><div style="color:var(--muted)">This section is generated by the hub export.</div></div>`;
}

async function loadJSON(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
  return await r.json();
}

function iconCell(icon){
  if(!icon) return "";
  return `<img class="splitIconImg" src="" alt="" loading="lazy" onerror="this.remove()">`;
}

function buildSplitsTable(splits){
  const rows = splits.map(s=>{
    const name = s.name || s.split || "";
    const icon = s.icon_path || s.icon_data_url || null;
    const pbSeg = s.pb_segment || s.pbSegment || s.pb_seg || s.pb || s.pb_segment_time || "";
    const bestSeg = s.best_segment || s.bestSegment || "";
    const pbSplit = s.pb_split || s.pbSplit || "";
    const avgSeg = s.avg_segment || s.avgSegment || "";
    const n = s.n ?? s.attempts ?? "";
    const streamTime = s.stream_time || s.streamTime || "–";
    const visits = s.visits ?? 0;
    const deaths = s.deaths ?? 0;
    return `<tr>
      <td><div class="splitNameCell">${iconCell(icon)}<span>${name}</span></div></td>
      <td class="time">${pbSeg||"–"}</td>
      <td class="time">${bestSeg||"–"}</td>
      <td class="time">${pbSplit||"–"}</td>
      <td class="time">${avgSeg||"–"}</td>
      <td>${n||"–"}</td>
      <td>${streamTime||"–"}</td>
      <td>${visits}</td>
      <td>${deaths}</td>
    </tr>`;
  }).join("");
  return `<div class="card" style="padding:0">
    <div style="padding:14px 14px 0 14px; font-weight:900; font-size:20px"><i class="fa-solid fa-list"></i> Splits</div>
    <div style="overflow:auto; border-radius:16px">
      <table class="splitsTable">
        <thead>
          <tr>
            <th>Split</th>
            <th><i class="fa-solid fa-stopwatch"></i> PB Segment</th>
            <th><i class="fa-solid fa-star"></i> Best Segment</th>
            <th><i class="fa-solid fa-flag-checkered"></i> PB Split</th>
            <th><i class="fa-solid fa-chart-line"></i> Ø Segment</th>
            <th>n</th>
            <th><i class="fa-solid fa-clock"></i> Stream Time</th>
            <th><i class="fa-solid fa-rotate"></i> Visits</th>
            <th><i class="fa-solid fa-skull"></i> Deaths</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  </div>`;
}

function buildSRTable(runs, highlightName="THXel"){
  const limit = 25;
  const shown = runs.slice(0, limit);
  const rows = shown.map((r,i)=>{
    const runner = r.runner || r.player || "";
    const cls = runner.toLowerCase()===highlightName.toLowerCase() ? "me" : "";
    return `<tr class="${cls}">
      <td>${i+1}</td>
      <td>${runner}</td>
      <td class="time">${r.time||""}</td>
      <td>${r.date||""}</td>
      <td>${r.url ? `<a href="${r.url}" target="_blank" rel="noopener">open</a>` : ""}</td>
    </tr>`;
  }).join("");
  return `<div class="card" style="padding:0">
    <div style="padding:14px 14px 10px 14px; font-weight:900; font-size:18px"><i class="fa-solid fa-trophy"></i> speedrun.com</div>
    <div class="srTableWrap">
      <table class="srTable">
        <thead><tr><th>#</th><th>Runner</th><th>Time</th><th>Date</th><th>Run</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div style="padding:10px 14px; color:var(--muted); font-size:12px">Showing top ${limit}. Scroll for more.</div>
  </div>`;
}

async function renderBoshy(){
  const data = await loadJSON("boshy_speedrun.json");
  const title = data.game || "I Wanna Be The Boshy";
  const updated = data.updated_at_utc || data.updated_at || "";
  // categories schema
  let cats = [];
  if(Array.isArray(data.categories)) cats = data.categories;
  else cats = [{name: data.category || "Any%", splits: data.splits || [], runs: (data.speedrun_com||{}).runs || []}];

  const pills = cats.map((c,idx)=>`<button class="pill ${idx===0?"active":""}" data-idx="${idx}">${c.name||c.category||("Cat "+(idx+1))}</button>`).join("");
  $("#view").innerHTML = `
    <div class="h1"><i class="fa-solid fa-stopwatch"></i> Boshy Speedrun</div>
    <div class="pills">${pills}</div>
    <div class="card" style="margin-bottom:14px">
      <div style="font-weight:900; font-size:22px">${title}</div>
      <div style="color:var(--muted); margin-top:4px">updated ${updated}</div>
    </div>
    <div class="grid2">
      <div id="leftCol"></div>
      <div id="rightCol"></div>
    </div>
    <div style="height:14px"></div>
    <div id="splits"></div>
  `;

  function renderCat(i){
    const c = cats[i];
    // Left: your stats
    const pb = data.pb_total || data.pb || "";
    const sob = data.sum_of_best || data.sob || "";
    const last = (data.last_final || data.last || pb) || "";
    $("#leftCol").innerHTML = `
      <div class="card" style="margin-bottom:14px">
        <div style="font-weight:900; font-size:18px"><i class="fa-solid fa-chart-column"></i> THXel's Run Stats</div>
        <div style="display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px">
          <div class="card"><div style="font-weight:900">PB Total</div><div style="font-size:26px; font-weight:900">${pb||"–"}</div></div>
          <div class="card"><div style="font-weight:900">Sum of Best</div><div style="font-size:26px; font-weight:900">${sob||"–"}</div></div>
          <div class="card"><div style="font-weight:900">Last Final</div><div style="font-size:26px; font-weight:900">${last||"–"}</div></div>
        </div>
      </div>
    `;
    // Right: SR
    const runs = (c.speedrun_com && c.speedrun_com.runs) ? c.speedrun_com.runs : (data.speedrun_com && data.speedrun_com.runs) ? data.speedrun_com.runs : [];
    $("#rightCol").innerHTML = buildSRTable(runs, "THXel");
    // Splits
    $("#splits").innerHTML = buildSplitsTable(c.splits || []);
    $$(".pill").forEach(p=>p.classList.toggle("active", Number(p.dataset.idx)===i));
  }

  $$(".pill").forEach(p=>p.addEventListener("click", ()=>renderCat(Number(p.dataset.idx))));
  renderCat(0);
}

function route(){
  const h = (location.hash||"#lib").replace("#","").trim();
  const tab = h || "lib";
  setActiveTab(tab);
  if(tab==="boshy") renderBoshy().catch(e=>{ $("#view").innerHTML=`<div class="card"><div class="h1">Boshy Speedrun</div><div style="color:#ffb3b3">Failed to load data: ${e}</div></div>`;});
  else if(tab==="stats") renderPlaceholder("Stats");
  else renderPlaceholder("Library");
}

$$(".tabBtn").forEach(b=>b.addEventListener("click", ()=>{ setHash(b.dataset.tab); route(); }));
window.addEventListener("hashchange", route);
route();
</script>
</body>
</html>
