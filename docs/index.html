\
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>THXel Fangame Hub Public</title>
  <link rel="stylesheet" href="assets/style.css" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" referrerpolicy="no-referrer">
</head>
<body>
  <div class="tabBar">
    <button class="tabBtn" data-tab="lib"><i class="fa-solid fa-book"></i> Library</button>
    <button class="tabBtn" data-tab="stats"><i class="fa-solid fa-chart-simple"></i> Stats</button>
    <button class="tabBtn" data-tab="boshy"><i class="fa-solid fa-stopwatch"></i> Boshy Speedrun</button>
  </div>

  <div id="view"></div>

<script>
const $ = (sel, el=document)=>el.querySelector(sel);
const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));

function setActiveTab(tab){
  $$(".tabBtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
}

function setHash(tab){ location.hash = tab; }

function renderPlaceholder(title){
  $("#view").innerHTML = `<div class="card"><div class="h1">${title}</div><div style="color:var(--muted)">This section is generated by the hub export.</div></div>`;
}

async function loadJSON(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
  return await r.json();
}

function iconCell(icon){
  if(!icon) return "";
  return `<img class="splitIconImg" src="" alt="" loading="lazy" onerror="this.remove()">`;
}

function buildSplitsTable(splits){
  const rows = splits.map(s=>{
    const name = s.name || s.split || "";
    const icon = s.icon_path || s.icon_data_url || null;
    const pbSeg = s.pb_segment || s.pbSegment || s.pb_seg || s.pb || s.pb_segment_time || "";
    const bestSeg = s.best_segment || s.bestSegment || "";
    const pbSplit = s.pb_split || s.pbSplit || "";
    const avgSeg = s.avg_segment || s.avgSegment || "";
    const n = s.n ?? s.attempts ?? "";
    const streamTime = s.stream_time || s.streamTime || "–";
    const visits = s.visits ?? 0;
    const deaths = s.deaths ?? 0;
    return `<tr>
      <td><div class="splitNameCell">${iconCell(icon)}<span>${name}</span></div></td>
      <td class="time">${pbSeg||"–"}</td>
      <td class="time">${bestSeg||"–"}</td>
      <td class="time">${pbSplit||"–"}</td>
      <td class="time">${avgSeg||"–"}</td>
      <td>${n||"–"}</td>
      <td>${streamTime||"–"}</td>
      <td>${visits}</td>
      <td>${deaths}</td>
    </tr>`;
  }).join("");
  return `<div class="card" style="padding:0">
    <div style="padding:14px 14px 0 14px; font-weight:900; font-size:20px"><i class="fa-solid fa-list"></i> Splits</div>
    <div style="overflow:auto; border-radius:16px">
      <table class="splitsTable">
        <thead>
          <tr>
            <th>Split</th>
            <th><i class="fa-solid fa-stopwatch"></i> PB Segment</th>
            <th><i class="fa-solid fa-star"></i> Best Segment</th>
            <th><i class="fa-solid fa-flag-checkered"></i> PB Split</th>
            <th><i class="fa-solid fa-chart-line"></i> Ø Segment</th>
            <th>n</th>
            <th><i class="fa-solid fa-clock"></i> Stream Time</th>
            <th><i class="fa-solid fa-rotate"></i> Visits</th>
            <th><i class="fa-solid fa-skull"></i> Deaths</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  </div>`;
}

function buildSRTable(runs, highlightName="THXel"){
  const limit = 25;
  const shown = runs.slice(0, limit);
  const rows = shown.map((r,i)=>{
    const runner = r.runner || r.player || "";
    const cls = runner.toLowerCase()===highlightName.toLowerCase() ? "me" : "";
    return `<tr class="${cls}">
      <td>${i+1}</td>
      <td>${runner}</td>
      <td class="time">${r.time||""}</td>
      <td>${r.date||""}</td>
      <td>${r.url ? `<a href="${r.url}" target="_blank" rel="noopener">open</a>` : ""}</td>
    </tr>`;
  }).join("");
  return `<div class="card" style="padding:0">
    <div style="padding:14px 14px 10px 14px; font-weight:900; font-size:18px"><i class="fa-solid fa-trophy"></i> speedrun.com</div>
    <div class="srTableWrap">
      <table class="srTable">
        <thead><tr><th>#</th><th>Runner</th><th>Time</th><th>Date</th><th>Run</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div style="padding:10px 14px; color:var(--muted); font-size:12px">Showing top ${limit}. Scroll for more.</div>
  </div>`;
}

async function renderBoshy(){
  const data = await loadJSON("boshy_speedrun.json");
  const title = data.game || "I Wanna Be The Boshy";
  const updated = data.updated_at_utc || data.updated_at || "";
  // categories schema
  let cats = [];
  if(Array.isArray(data.categories)) cats = data.categories;
  else cats = [{name: data.category || "Any%", splits: data.splits || [], runs: (data.speedrun_com||{}).runs || []}];

  const pills = cats.map((c,idx)=>`<button class="pill ${idx===0?"active":""}" data-idx="${idx}">${c.name||c.category||("Cat "+(idx+1))}</button>`).join("");
  $("#view").innerHTML = `
    <div class="h1"><i class="fa-solid fa-stopwatch"></i> Boshy Speedrun</div>
    <div class="pills">${pills}</div>
    <div class="card" style="margin-bottom:14px">
      <div style="font-weight:900; font-size:22px">${title}</div>
      <div style="color:var(--muted); margin-top:4px">updated ${updated}</div>
    </div>
    <div class="grid2">
      <div id="leftCol"></div>
      <div id="rightCol"></div>
    </div>
    <div style="height:14px"></div>
    <div id="splits"></div>
  `;

  function renderCat(i){
    const c = cats[i];
    // Left: your stats
    const pb = data.pb_total || data.pb || "";
    const sob = data.sum_of_best || data.sob || "";
    const last = (data.last_final || data.last || pb) || "";
    $("#leftCol").innerHTML = `
      <div class="card" style="margin-bottom:14px">
        <div style="font-weight:900; font-size:18px"><i class="fa-solid fa-chart-column"></i> THXel's Run Stats</div>
        <div style="display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px">
          <div class="card"><div style="font-weight:900">PB Total</div><div style="font-size:26px; font-weight:900">${pb||"–"}</div></div>
          <div class="card"><div style="font-weight:900">Sum of Best</div><div style="font-size:26px; font-weight:900">${sob||"–"}</div></div>
          <div class="card"><div style="font-weight:900">Last Final</div><div style="font-size:26px; font-weight:900">${last||"–"}</div></div>
        </div>
      </div>
    `;
    // Right: SR
    const runs = (c.speedrun_com && c.speedrun_com.runs) ? c.speedrun_com.runs : (data.speedrun_com && data.speedrun_com.runs) ? data.speedrun_com.runs : [];
    $("#rightCol").innerHTML = buildSRTable(runs, "THXel");
    // Splits
    $("#splits").innerHTML = buildSplitsTable(c.splits || []);
    $$(".pill").forEach(p=>p.classList.toggle("active", Number(p.dataset.idx)===i));
  }

  $$(".pill").forEach(p=>p.addEventListener("click", ()=>renderCat(Number(p.dataset.idx))));
  renderCat(0);
}

function route(){
  const h = (location.hash||"#lib").replace("#","").trim();
  const tab = h || "lib";
  setActiveTab(tab);
  if(tab==="boshy") renderBoshy().catch(e=>{ $("#view").innerHTML=`<div class="card"><div class="h1">Boshy Speedrun</div><div style="color:#ffb3b3">Failed to load data: ${e}</div></div>`;});
  else if(tab==="stats") renderPlaceholder("Stats");
  else renderPlaceholder("Library");
}

$$(".tabBtn").forEach(b=>b.addEventListener("click", ()=>{ setHash(b.dataset.tab); route(); }));
window.addEventListener("hashchange", route);
route();
</script>

<!-- BOSHY UI OVERRIDE v15 -->
<style>

/* BOSHY UI OVERRIDE v15 */
:root{ color-scheme: dark; }
body{ background:#0b0d14; color:#e8eaf2; }
a{ color:#8ab4ff; }
.tabBar, .tabs, .tabBtn{ color:#e8eaf2; }
#boshySection, [data-tab-panel="boshy"], .boshyPanel{ color:#e8eaf2; }

/* Category chips / pills */
.boshyCatBtn, .chip, .pill, .segChip{
  color:#ffffff !important;
}

/* Splits table */
#boshySplitsTable, .boshySplitsTable, table.splitsTable{ width:100%; }
#boshySplitsTable tbody td, .boshySplitsTable tbody td, table.splitsTable tbody td{
  font-size: 14px !important;
  line-height: 1.25 !important;
}
.boshySplitNameCell{ display:flex; align-items:center; gap:10px; }
.boshySplitIcon{
  width:18px; height:18px; flex:0 0 18px;
  border-radius:4px;
  image-rendering: pixelated;
  background: rgba(255,255,255,0.06);
  box-shadow: 0 0 0 1px rgba(255,255,255,0.10) inset;
}

/* speedrun.com list: show 25 rows then scroll */
#srTableWrap, .srTableWrap, .speedrunTableWrap{
  max-height: 540px; /* tuned for your left stats column */
  overflow: auto;
}

</style>
<script>

// BOSHY UI OVERRIDE v15
(function(){
  const MARK = "BOSHY UI OVERRIDE v15";
  if (window.__boshy_ui_override_v15) return;
  window.__boshy_ui_override_v15 = true;

  function cacheBust(url){
    const u = new URL(url, window.location.href);
    u.searchParams.set("v", String(Date.now()));
    return u.toString();
  }

  async function fetchBoshyJson(){
    try{
      const res = await fetch(cacheBust("boshy_speedrun.json"), {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      return await res.json();
    }catch(e){
      console.warn("[boshy-ui]", "failed to load boshy_speedrun.json", e);
      return null;
    }
  }

  function normalizeName(s){
    return String(s||"").trim().toLowerCase();
  }

  function buildIconMap(data){
    // supports both {splits:[...]} and {boshy:{categories:[{splits:[]}]} }
    const map = new Map();
    if(!data) return map;

    function addSplits(arr){
      (arr||[]).forEach(sp=>{
        const n = normalizeName(sp.name);
        if(!n) return;
        const icon = sp.icon_data_url || sp.iconDataUrl || null;
        const iconPath = sp.icon_path || sp.iconPath || null;
        if(icon || iconPath){
          map.set(n, icon || iconPath);
        }
      });
    }

    if(Array.isArray(data.splits)) addSplits(data.splits);

    const boshy = data.boshy || null;
    const cats = boshy && Array.isArray(boshy.categories) ? boshy.categories : null;
    if(cats){
      cats.forEach(c=> addSplits(c.splits));
    }
    return map;
  }

  function findSplitsTable(){
    // Try common IDs/classes first
    let t = document.getElementById("boshySplitsTable");
    if (t) return t;
    t = document.querySelector("table.boshySplitsTable, table.splitsTable");
    if (t) return t;

    // Fallback: find a table under Boshy tab that has a header cell containing "Split"
    const boshyPanel = document.querySelector("[data-tab-panel='boshy'], #tab_boshy, #boshy, .boshyPanel, #boshySection") || document;
    const tables = boshyPanel.querySelectorAll("table");
    for (const table of tables){
      const th = table.querySelector("thead th, thead td");
      if (th && /split/i.test(th.textContent||"")) return table;
    }
    return null;
  }

  function ensureIconCell(td){
    if(!td) return null;
    // If we already added wrapper, do nothing
    if (td.querySelector(".boshySplitIcon")) return td;

    td.classList.add("boshySplitNameCell");

    // Remove "checkbox placeholder" if present (input type=checkbox or an empty square)
    const cb = td.querySelector("input[type='checkbox']");
    if(cb){
      cb.remove();
    }

    const img = document.createElement("img");
    img.className = "boshySplitIcon";
    img.alt = "";
    img.loading = "lazy";

    // Prepend
    td.insertBefore(img, td.firstChild);
    return td;
  }

  function applyIcons(iconMap){
    const table = findSplitsTable();
    if(!table) return;

    const rows = table.querySelectorAll("tbody tr");
    rows.forEach(tr=>{
      const tds = tr.querySelectorAll("td");
      if(!tds || !tds.length) return;

      // Some layouts have first col as the split name, others second col.
      // Pick the first cell that has non-empty text and is not just "—" or a number.
      let nameTd = null;
      for (const td of tds){
        const txt = (td.textContent||"").trim();
        if(!txt) continue;
        if(txt === "—" || txt === "-" ) continue;
        if(/^\d+$/.test(txt)) continue;
        nameTd = td;
        break;
      }
      if(!nameTd) nameTd = tds[0];

      const txt = (nameTd.textContent||"").trim();
      const key = normalizeName(txt);
      const icon = iconMap.get(key);
      const cell = ensureIconCell(nameTd);
      if(!cell) return;

      const img = cell.querySelector("img.boshySplitIcon");
      if(!img) return;

      if(icon){
        img.src = icon;
        img.style.opacity = "1";
      }else{
        // keep subtle placeholder
        img.removeAttribute("src");
        img.style.opacity = "0.35";
      }
    });
  }

  function limitSpeedrunTable(){
    // Wrap the speedrun.com table in a scroll container and cap visible rows to 25.
    const panel = document.querySelector("[data-tab-panel='boshy'], #boshy, #boshySection, .boshyPanel") || document;
    const table = panel.querySelector("table#srTable, table.speedrunTable, table[data-sr='table']");
    if(!table) return;

    let wrap = table.closest("#srTableWrap, .srTableWrap, .speedrunTableWrap");
    if(!wrap){
      wrap = document.createElement("div");
      wrap.id = "srTableWrap";
      table.parentNode.insertBefore(wrap, table);
      wrap.appendChild(table);
    }
    // Hide rows > 25 but keep them for scroll if table already paginates; we instead rely on wrap scroll.
    // If you WANT only 25 rows rendered, you'd have to change the renderer; this keeps it simple.
    wrap.style.maxHeight = wrap.style.maxHeight || "540px";
    wrap.style.overflow = "auto";
  }

  async function boot(){
    const data = await fetchBoshyJson();
    const iconMap = buildIconMap(data);

    const run = () => {
      applyIcons(iconMap);
      limitSpeedrunTable();
    };

    run();

    // Re-apply on tab switches / dynamic renders
    const mo = new MutationObserver(()=>run());
    mo.observe(document.body, {subtree:true, childList:true});

    // Also re-apply on hash changes (#boshy)
    window.addEventListener("hashchange", run);
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", boot);
  }else{
    boot();
  }
})();

</script>
<!-- /BOSHY UI OVERRIDE v15 -->
</body>
</html>
